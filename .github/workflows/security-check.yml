name: Security & Secrets Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  check-secrets:
    name: Check for Exposed Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for .env files
        run: |
          echo "ðŸ” Checking for .env files..."

          BASE_REF="HEAD~1"
          if ! git rev-parse "$BASE_REF" >/dev/null 2>&1; then
            BASE_REF="HEAD"
          fi
          
          # Check if .env files exist in the commit
          CHANGED_ENV_FILES=$(git diff --name-only "$BASE_REF" HEAD | grep -E '\.env$|\.env\..*$|myenv$' | grep -vE '(^|/)\.env\.example$' || true)
          if [ -n "$CHANGED_ENV_FILES" ]; then
            echo "ERROR: .env or myenv files detected in commit!"
            echo "The following sensitive files were found:"
            echo "$CHANGED_ENV_FILES"
            exit 1
          fi
          
          # Check if .env files exist in the repository
          ENV_FILES=$(find . \( -name ".env" -o -name ".env.*" -o -name "myenv" \) | grep -v node_modules | grep -vE '(^|/)\.env\.example$' || true)
          if [ -n "$ENV_FILES" ]; then
            echo "ERROR: .env or myenv files found in repository!"
            echo "Please remove these files and add them to .gitignore"
            echo "$ENV_FILES"
            exit 1
          fi
          
          echo "No .env files detected"
      
      - name: TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: Check for hardcoded secrets
        run: |
          echo "ðŸ” Checking for hardcoded secrets..."
          
          # Check for common secret patterns
          if grep -r -i -E "(password|api_key|secret_key|private_key|token)\s*=\s*['\"][^'\"]{8,}['\"]" . \
            --exclude-dir={.git,node_modules,venv,__pycache__,.next,dist,build} \
            --exclude="*.{md,txt,json,lock,log,yml,yaml}"; then
            echo "WARNING: Potential hardcoded secrets detected!"
            echo "Please review and move to environment variables"
          else
            echo "No obvious hardcoded secrets found"
          fi
      
      - name: Check .gitignore coverage
        run: |
          echo "Verifying .gitignore includes sensitive files..."
          
          REQUIRED_IGNORES=(".env" ".env.*" "*.env" "myenv" "venv/" "node_modules/" "__pycache__/" "*.pyc" ".DS_Store")
          
          for pattern in "${REQUIRED_IGNORES[@]}"; do
            if ! grep -q "$pattern" .gitignore 2>/dev/null; then
              echo "WARNING: $pattern not found in .gitignore"
            fi
          done
          
          echo " .gitignore check complete"
