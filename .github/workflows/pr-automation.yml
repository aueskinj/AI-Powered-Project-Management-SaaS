name: PR Automation & Linking

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  link-issues:
    name: Link PR to Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Link PR to Issues
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const prTitle = pr.title || '';
            
            // Extract issue numbers from PR body and title
            const issueRegex = /#(\d+)|closes #(\d+)|fixes #(\d+)|resolves #(\d+)/gi;
            const matches = [...prBody.matchAll(issueRegex), ...prTitle.matchAll(issueRegex)];
            const issueNumbers = [...new Set(matches.map(m => m[1] || m[2] || m[3] || m[4]))];
            
            if (issueNumbers.length === 0) {
              core.warning('No linked issues found. Use "Closes #123" or "Fixes #456" in PR description.');
              
              // Add a comment suggesting to link issues
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '**No linked issues detected**\n\nPlease link this PR to related issues using:\n- `Closes #123`\n- `Fixes #456`\n- `Resolves #789`\n\nThis helps with automatic issue closure and tracking.'
              });
            } else {
              console.log(`Found linked issues: ${issueNumbers.join(', ')}`);
              
              // Comment on PR with linked issues
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `**Linked Issues:** ${issueNumbers.map(n => `#${n}`).join(', ')}\n\nThese issues will be automatically closed when this PR is merged.`
              });
            }
      
      - name: Check PR Labels
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            
            const requiredLabels = ['enhancement', 'bug', 'documentation', 'refactor'];
            const hasRequiredLabel = requiredLabels.some(label => labels.includes(label));
            
            if (!hasRequiredLabel) {
              core.warning('No type label found. Please add one: enhancement, bug, documentation, or refactor');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: '**Missing PR Type Label**\n\nPlease add one of the following labels:\n- `enhancement` - New feature\n- `bug` - Bug fix\n- `documentation` - Docs update\n- `refactor` - Code refactoring'
              });
            }

  auto-close-issues:
    name: Auto-close Linked Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Find and Close Linked Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Get the commit messages from the push
            const commits = context.payload.commits || [];
            
            console.log(`Processing ${commits.length} commits...`);
            
            const issueRegex = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const allIssueNumbers = new Set();
            
            for (const commit of commits) {
              const message = `${commit.message}\n${commit.body || ''}`;
              const matches = [...message.matchAll(issueRegex)];
              
              matches.forEach(match => {
                const issueNumber = match[3];
                allIssueNumbers.add(issueNumber);
              });
            }
            
            console.log(`Found ${allIssueNumbers.size} issues to close: ${[...allIssueNumbers].join(', ')}`);
            
            // Close each issue
            for (const issueNumber of allIssueNumbers) {
              try {
                // Check if issue exists and is open
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });
                
                if (issue.state === 'open') {
                  // Close the issue
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    state: 'closed'
                  });
                  
                  // Add a closing comment
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `Automatically closed by commit ${context.sha.substring(0, 7)} in PR that was merged to main.`
                  });
                  
                  console.log(`Closed issue #${issueNumber}`);
                } else {
                  console.log(`Issue #${issueNumber} is already closed`);
                }
              } catch (error) {
                console.error(`Error processing issue #${issueNumber}:`, error.message);
              }
            }
            
            if (allIssueNumbers.size === 0) {
              console.log('No issues to close in this push');
            }

  pr-size-check:
    name: Check PR Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Check PR Size
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changedFiles = pr.changed_files;
            
            let size = 'small';
            let emoji = 'ðŸ‘ðŸ¾';
            let message = 'This PR is a good size for review!';
            
            if (additions + deletions > 1000 || changedFiles > 20) {
              size = 'extra-large';
              emoji = 'ðŸ˜¬';
              message = 'This PR is very large. Consider breaking it into smaller PRs for easier review.';
            } else if (additions + deletions > 500 || changedFiles > 10) {
              size = 'large';
              emoji = 'ðŸ˜‘';
              message = 'This PR is quite large. Consider breaking it into smaller chunks if possible.';
            } else if (additions + deletions > 200 || changedFiles > 5) {
              size = 'medium';
              emoji = 'ðŸ«¡';
              message = 'This PR is a reasonable size for review.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `${emoji} **PR Size: ${size}**\n\n` +
                    `**Statistics:**\n` +
                    `- Lines added: ${additions}\n` +
                    `- Lines deleted: ${deletions}\n` +
                    `- Files changed: ${changedFiles}\n\n` +
                    `${message}`
            });
